<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Timetable</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fff;
      color: #37352f;
      font-size: 12px;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      background: #fafafa;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 6px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 11px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #f0f0f0;
    }

    .week-start-select {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .week-start-select select {
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 11px;
    }

    /* Timetable */
    .timetable-wrapper {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    .timetable {
      display: grid;
      grid-template-columns: 50px repeat(7, 1fr);
      min-width: 600px;
    }

    /* Header row */
    .day-header {
      position: sticky;
      top: 0;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      padding: 8px 4px;
      text-align: center;
      font-weight: 600;
      z-index: 10;
    }

    .time-header {
      position: sticky;
      top: 0;
      left: 0;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      border-right: 1px solid #e0e0e0;
      z-index: 11;
    }

    /* Time column */
    .time-column {
      position: sticky;
      left: 0;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      z-index: 5;
    }

    .time-slot {
      height: 60px;
      padding: 4px 8px;
      border-bottom: 1px solid #f0f0f0;
      color: #999;
      font-size: 10px;
    }

    /* Day columns */
    .day-column {
      position: relative;
      border-right: 1px solid #f0f0f0;
    }

    .hour-slot {
      height: 60px;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }

    .hour-slot:hover {
      background: #f8f8f8;
    }

    /* Events */
    .event {
      position: absolute;
      left: 2px;
      right: 2px;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 11px;
      overflow: hidden;
      cursor: pointer;
      z-index: 2;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .event-title {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-time {
      font-size: 9px;
      opacity: 0.8;
      margin-top: 2px;
    }

    /* Drag selection */
    .drag-selection {
      position: absolute;
      left: 2px;
      right: 2px;
      background: rgba(59, 130, 246, 0.3);
      border: 2px dashed #3B82F6;
      border-radius: 4px;
      z-index: 3;
      pointer-events: none;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 320px;
      max-width: 90vw;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .modal h3 {
      margin-bottom: 16px;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: #666;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .time-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .time-inputs input {
      width: 80px;
    }

    .color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .color-option {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: #333;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    .btn-primary {
      background: #3B82F6;
      color: #fff;
      border-color: #3B82F6;
    }

    .btn-primary:hover {
      background: #2563EB;
    }

    .btn-danger {
      background: #EF4444;
      color: #fff;
      border-color: #EF4444;
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    /* Hidden file input */
    #import-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="btn" id="export-btn">エクスポート</button>
        <button class="btn" id="import-btn">インポート</button>
        <input type="file" id="import-input" accept=".json">
      </div>
      <div class="week-start-select">
        <span>週の始まり:</span>
        <select id="week-start">
          <option value="monday">月曜</option>
          <option value="sunday">日曜</option>
        </select>
      </div>
    </div>
    <div class="timetable-wrapper" id="timetable-wrapper">
      <div class="timetable" id="timetable"></div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h3 id="modal-title">イベントを追加</h3>
      <div class="form-group">
        <label>タイトル</label>
        <input type="text" id="event-title" placeholder="仕事、勉強など">
      </div>
      <div class="form-group">
        <label>時間</label>
        <div class="time-inputs">
          <input type="time" id="event-start">
          <span>〜</span>
          <input type="time" id="event-end">
        </div>
      </div>
      <div class="form-group">
        <label>色</label>
        <div class="color-picker" id="color-picker"></div>
      </div>
      <div class="form-group">
        <label>メモ（任意）</label>
        <textarea id="event-memo" placeholder="メモを入力..."></textarea>
      </div>
      <div class="modal-buttons">
        <button class="btn" id="modal-cancel">キャンセル</button>
        <button class="btn btn-danger" id="modal-delete" style="display:none;">削除</button>
        <button class="btn btn-primary" id="modal-save">保存</button>
      </div>
    </div>
  </div>

  <script>
    // Colors
    const COLORS = [
      { name: 'blue', value: '#3B82F6', text: '#fff' },
      { name: 'green', value: '#22C55E', text: '#fff' },
      { name: 'yellow', value: '#EAB308', text: '#000' },
      { name: 'orange', value: '#F97316', text: '#fff' },
      { name: 'red', value: '#EF4444', text: '#fff' },
      { name: 'purple', value: '#A855F7', text: '#fff' },
      { name: 'gray', value: '#9CA3AF', text: '#fff' },
    ];

    // Days
    const DAYS_MONDAY = ['月', '火', '水', '木', '金', '土', '日'];
    const DAYS_SUNDAY = ['日', '月', '火', '水', '木', '金', '土'];

    // State
    let state = {
      settings: {
        weekStartsOn: 'monday'
      },
      events: []
    };

    let currentDrag = null;
    let editingEvent = null;

    // Load state from localStorage
    function loadState() {
      const saved = localStorage.getItem('weekly-timetable');
      if (saved) {
        state = JSON.parse(saved);
      }
    }

    // Save state to localStorage
    function saveState() {
      localStorage.setItem('weekly-timetable', JSON.stringify(state));
    }

    // Generate UUID
    function generateId() {
      return 'id-' + Math.random().toString(36).substr(2, 9);
    }

    // Get days array based on week start
    function getDays() {
      return state.settings.weekStartsOn === 'sunday' ? DAYS_SUNDAY : DAYS_MONDAY;
    }

    // Convert day index based on week start
    function getDayIndex(dayName) {
      return getDays().indexOf(dayName);
    }

    // Time to minutes
    function timeToMinutes(time) {
      const [h, m] = time.split(':').map(Number);
      return h * 60 + m;
    }

    // Minutes to time string
    function minutesToTime(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // Snap to 15 minutes
    function snapTo15(minutes) {
      return Math.round(minutes / 15) * 15;
    }

    // Render timetable
    function render() {
      const timetable = document.getElementById('timetable');
      timetable.innerHTML = '';

      const days = getDays();

      // Header row
      const timeHeader = document.createElement('div');
      timeHeader.className = 'time-header day-header';
      timetable.appendChild(timeHeader);

      days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        timetable.appendChild(header);
      });

      // Time column
      const timeColumn = document.createElement('div');
      timeColumn.className = 'time-column';
      for (let h = 0; h < 24; h++) {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.textContent = `${h}:00`;
        timeColumn.appendChild(slot);
      }
      timetable.appendChild(timeColumn);

      // Day columns
      days.forEach((day, dayIndex) => {
        const column = document.createElement('div');
        column.className = 'day-column';
        column.dataset.day = dayIndex;

        for (let h = 0; h < 24; h++) {
          const slot = document.createElement('div');
          slot.className = 'hour-slot';
          slot.dataset.hour = h;
          column.appendChild(slot);
        }

        // Add events for this day
        const dayEvents = state.events.filter(e => e.day === dayIndex);
        renderDayEvents(column, dayEvents);

        // Drag handlers
        column.addEventListener('mousedown', handleDragStart);
        column.addEventListener('mousemove', handleDragMove);
        column.addEventListener('mouseup', handleDragEnd);
        column.addEventListener('mouseleave', handleDragEnd);

        timetable.appendChild(column);
      });

      // Update week start select
      document.getElementById('week-start').value = state.settings.weekStartsOn;
    }

    // Render events for a day with overlap handling
    function renderDayEvents(column, events) {
      if (events.length === 0) return;

      // Sort by start time
      events.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

      // Find overlapping groups
      const groups = [];
      events.forEach(event => {
        const eventStart = timeToMinutes(event.startTime);
        const eventEnd = timeToMinutes(event.endTime);

        let placed = false;
        for (const group of groups) {
          const overlaps = group.some(e => {
            const eStart = timeToMinutes(e.startTime);
            const eEnd = timeToMinutes(e.endTime);
            return eventStart < eEnd && eventEnd > eStart;
          });

          if (overlaps) {
            group.push(event);
            placed = true;
            break;
          }
        }

        if (!placed) {
          groups.push([event]);
        }
      });

      // Render each group
      groups.forEach(group => {
        const width = 100 / group.length;
        group.forEach((event, index) => {
          renderEvent(column, event, width, index * width);
        });
      });
    }

    // Render single event
    function renderEvent(column, event, widthPercent = 100, leftPercent = 0) {
      const color = COLORS.find(c => c.name === event.color) || COLORS[0];
      const startMinutes = timeToMinutes(event.startTime);
      const endMinutes = timeToMinutes(event.endTime);
      const top = (startMinutes / 60) * 60; // 60px per hour
      const height = ((endMinutes - startMinutes) / 60) * 60;

      const el = document.createElement('div');
      el.className = 'event';
      el.dataset.id = event.id;
      el.style.top = `${top}px`;
      el.style.height = `${Math.max(height, 20)}px`;
      el.style.background = color.value;
      el.style.color = color.text;
      el.style.left = `calc(${leftPercent}% + 2px)`;
      el.style.width = `calc(${widthPercent}% - 4px)`;

      el.innerHTML = `
        <div class="event-title">${event.icon || ''} ${event.title}</div>
        <div class="event-time">${event.startTime} - ${event.endTime}</div>
      `;

      el.addEventListener('click', (e) => {
        e.stopPropagation();
        openEditModal(event);
      });

      column.appendChild(el);
    }

    // Drag handling
    function handleDragStart(e) {
      if (e.target.classList.contains('event')) return;

      const column = e.currentTarget;
      const rect = column.getBoundingClientRect();
      const y = e.clientY - rect.top + column.parentElement.parentElement.scrollTop;
      const minutes = snapTo15((y / 60) * 60);

      currentDrag = {
        day: parseInt(column.dataset.day),
        startY: y,
        startMinutes: Math.max(0, Math.min(1440, minutes)),
        currentMinutes: Math.max(0, Math.min(1440, minutes))
      };

      updateDragSelection(column);
    }

    function handleDragMove(e) {
      if (!currentDrag) return;

      const column = e.currentTarget;
      const rect = column.getBoundingClientRect();
      const y = e.clientY - rect.top + column.parentElement.parentElement.scrollTop;
      const minutes = snapTo15((y / 60) * 60);

      currentDrag.currentMinutes = Math.max(0, Math.min(1440, minutes));
      updateDragSelection(column);
    }

    function handleDragEnd(e) {
      if (!currentDrag) return;

      const column = e.currentTarget;
      removeDragSelection(column);

      const startMinutes = Math.min(currentDrag.startMinutes, currentDrag.currentMinutes);
      const endMinutes = Math.max(currentDrag.startMinutes, currentDrag.currentMinutes);

      if (endMinutes - startMinutes >= 15) {
        openCreateModal(currentDrag.day, startMinutes, endMinutes);
      }

      currentDrag = null;
    }

    function updateDragSelection(column) {
      removeDragSelection(column);

      const startMinutes = Math.min(currentDrag.startMinutes, currentDrag.currentMinutes);
      const endMinutes = Math.max(currentDrag.startMinutes, currentDrag.currentMinutes);

      const top = (startMinutes / 60) * 60;
      const height = ((endMinutes - startMinutes) / 60) * 60;

      const selection = document.createElement('div');
      selection.className = 'drag-selection';
      selection.style.top = `${top}px`;
      selection.style.height = `${Math.max(height, 15)}px`;
      column.appendChild(selection);
    }

    function removeDragSelection(column) {
      const existing = column.querySelector('.drag-selection');
      if (existing) existing.remove();
    }

    // Modal handling
    function openCreateModal(day, startMinutes, endMinutes) {
      editingEvent = null;
      document.getElementById('modal-title').textContent = 'イベントを追加';
      document.getElementById('event-title').value = '';
      document.getElementById('event-start').value = minutesToTime(startMinutes);
      document.getElementById('event-end').value = minutesToTime(endMinutes);
      document.getElementById('event-memo').value = '';
      document.getElementById('modal-delete').style.display = 'none';

      currentDrag = { day };
      renderColorPicker('blue');
      document.getElementById('modal-overlay').classList.add('active');
    }

    function openEditModal(event) {
      editingEvent = event;
      document.getElementById('modal-title').textContent = 'イベントを編集';
      document.getElementById('event-title').value = event.title;
      document.getElementById('event-start').value = event.startTime;
      document.getElementById('event-end').value = event.endTime;
      document.getElementById('event-memo').value = event.memo || '';
      document.getElementById('modal-delete').style.display = 'block';

      renderColorPicker(event.color);
      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      editingEvent = null;
      currentDrag = null;
    }

    function renderColorPicker(selectedColor) {
      const picker = document.getElementById('color-picker');
      picker.innerHTML = '';

      COLORS.forEach(color => {
        const el = document.createElement('div');
        el.className = 'color-option' + (color.name === selectedColor ? ' selected' : '');
        el.style.background = color.value;
        el.dataset.color = color.name;
        el.addEventListener('click', () => {
          picker.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
          el.classList.add('selected');
        });
        picker.appendChild(el);
      });
    }

    function saveEvent() {
      const title = document.getElementById('event-title').value.trim();
      const startTime = document.getElementById('event-start').value;
      const endTime = document.getElementById('event-end').value;
      const memo = document.getElementById('event-memo').value.trim();
      const colorEl = document.querySelector('.color-option.selected');
      const color = colorEl ? colorEl.dataset.color : 'blue';

      if (!title || !startTime || !endTime) {
        alert('タイトルと時間を入力してください');
        return;
      }

      if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
        alert('終了時間は開始時間より後にしてください');
        return;
      }

      if (editingEvent) {
        // Update existing event
        const index = state.events.findIndex(e => e.id === editingEvent.id);
        if (index !== -1) {
          state.events[index] = {
            ...state.events[index],
            title,
            startTime,
            endTime,
            color,
            memo
          };
        }
      } else {
        // Create new event
        state.events.push({
          id: generateId(),
          title,
          day: currentDrag.day,
          startTime,
          endTime,
          color,
          memo
        });
      }

      saveState();
      render();
      closeModal();
    }

    function deleteEvent() {
      if (!editingEvent) return;
      if (!confirm('このイベントを削除しますか？')) return;

      state.events = state.events.filter(e => e.id !== editingEvent.id);
      saveState();
      render();
      closeModal();
    }

    // Export/Import
    function exportData() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'weekly-timetable.json';
      a.click();

      URL.revokeObjectURL(url);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported.events && Array.isArray(imported.events)) {
            state = imported;
            saveState();
            render();
            alert('インポートしました');
          } else {
            alert('無効なファイル形式です');
          }
        } catch (err) {
          alert('ファイルの読み込みに失敗しました');
        }
      };
      reader.readAsText(file);
    }

    // Initialize
    function init() {
      loadState();
      render();

      // Scroll to 5:00
      setTimeout(() => {
        const wrapper = document.getElementById('timetable-wrapper');
        wrapper.scrollTop = 5 * 60; // 5 hours * 60px
      }, 100);

      // Event listeners
      document.getElementById('week-start').addEventListener('change', (e) => {
        state.settings.weekStartsOn = e.target.value;
        saveState();
        render();
      });

      document.getElementById('export-btn').addEventListener('click', exportData);
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-input').click();
      });
      document.getElementById('import-input').addEventListener('change', (e) => {
        if (e.target.files[0]) {
          importData(e.target.files[0]);
        }
      });

      document.getElementById('modal-cancel').addEventListener('click', closeModal);
      document.getElementById('modal-save').addEventListener('click', saveEvent);
      document.getElementById('modal-delete').addEventListener('click', deleteEvent);
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });
    }

    init();
  </script>
</body>
</html>